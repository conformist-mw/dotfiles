---
- name: Run mx container
  community.docker.docker_container:
    image: r.xmox.nl/mox:latest
    name: mox
    restart: true
    restart_policy: "unless-stopped"
    network_mode: "host"
    volumes:
      - "{{ data_dir }}/mox/config:/mox/config"
      - "{{ data_dir }}/mox/data:/mox/data"
      - "{{ data_dir }}/mox/web:/mox/web"
      - "{{ server_dir }}/letsencrypt/certs/:/mox/certs:ro"
    env:
      MOX_DOCKER: "yes"
    working_dir: "/mox"
    labels:
      traefik.enable: "true"
      traefik.http.routers.mx.entrypoints: "websecure"
      traefik.http.routers.mx.tls: "true"
      traefik.http.routers.mx.tls.certresolver: "letsencrypt"
      traefik.http.routers.mx.rule: "Host(`autoconfig.{{ ansible_host }}`,`mta-sts.{{ ansible_host }}`,`mail.{{ ansible_host }}`)"
      traefik.http.services.mx.loadbalancer.server.port: "81"
      traefik.http.routers.mx.middlewares: "no-auth-chain@file"
